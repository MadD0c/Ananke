################################
########## END_PRINT ###########
################################
[gcode_macro END_PRINT]
description: Present the finished print
gcode:
    {% set defaultcfg = printer['gcode_macro _defaultcfg'] %} ; get defaultcfg variables
    {% if defaultcfg.end_print == True %}
        {% if defaultcfg.led_status == True %}
            STATUS_PART_READY ; LED feedback
        {% endif %}
        STOP_COMPONENTS
        # Acknowledge success!
        M{defaultcfg.output} Print Complete ; status feedback
        {% if defaultcfg.audio_status == True %}
            {defaultcfg.success_audio} ; audio feedback
        {% endif %}
        {% if defaultcfg.led_status == True %}
            {defaultcfg.status_ready} ; LED feedback
        {% endif %}
        {% if defaultcfg.unload_filament == True %}
            {defaultcfg.m600} ; unload filament
        {% endif %}
        {% if defaultcfg.power_off == True %}
            {defaultcfg.off_macro} ; power off printer
        {% endif %}
    {% endif %}

################################
###### STOP_COMPONENTS #########
################################
[gcode_macro STOP_COMPONENTS]
gcode:
    {% set defaultcfg = printer['gcode_macro _defaultcfg'] %} ; get defaultcfg variables
    {% if defaultcfg.auto_filsensor == True %}
        # Disable filament sensor
        DISABLEFILAMENTSENSOR
    {% endif %}
    {% if defaultcfg.controller_fan == True %}
        {defaultcfg.controller_fan_stop}
    {% endif %}
    {% if defaultcfg.use_scrubber == True %}
        # Scrub VOCs
        SCRUBBER
    {% endif %}

################################
######## CANCEL_PRINT ##########
################################
[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
variable_park: True
gcode:
    {% set defaultcfg = printer['gcode_macro _defaultcfg'] %} ; get defaultcfg variables
    M{defaultcfg.output} Print Canceled ; status feedback
    {% if defaultcfg.led_status == True %}
        STATUS_ERROR ; LED feedback
    {% endif %}
    ## Move head and retract only if not already in the pause state and park set to true
    {% if printer.pause_resume.is_paused|lower == 'false' and park|lower == 'true'%}
        {% if printer.toolhead.homed_axes == "xyz" %}
            _TOOLHEAD_PARK_PAUSE_CANCEL
        {% endif %}
    {% endif %}
    {% if defaultcfg.audio_status == True %}
        {defaultcfg.error_audio} ; audio feedback
    {% endif %}
    STOP_COMPONENTS
    TURN_OFF_HEATERS
    CANCEL_PRINT_BASE
