[gcode_macro BACK]
gcode:
     M876 S1 
[gcode_macro NEXT]
gcode:
     m876 S2
[gcode_macro CANCEL]
gcode:
     m876 S1

[gcode_macro EXTRACT]
gcode:
     m876 S3

############################################u
############################################u
############################################u

#------------------------------------------------------u
# MOM - My Overpowered M600 macro / written by Jay Lexx
# Also tenderly called the Mother Of Macros by u/Woodcat64  
# Listen to MOM and everything will be alright!
#------------------------------------------------------
#  NO RESPONSE TAKEN FOR ANY DAMAGE CAUSED BY MOM ;)
#------------------------------------------------------
# 
#
# 09.11.2021 v0.1.6
#
# Sourcecode maintenance due to Klipper updates.
#
# v0.1.5
#
# - added ability to prevent nozzle cooldown
#
# Save this file f.e. as /home/pi/klipper_config/m600.cfg to leave printer.cfg nice and clean
# then use [include /home/pi/klipper_config/M600.cfg] in your printer.cfg
# Don't forget to configure default values in [gcode_makro m600cfg] down below
# 
#
# Usage in CURA Slicer:
# Extensions > Post Processing > Modify G-Code
#	Add a script -> Filament Change
#			Set Layer to value at which filament should be changed
#			I personally set the rest to 0, works like a charm
#			( Tbh, i even didn't check if they have any effect ) 
#
# The M600 command can also be used to just change filament from console or via Button, so, 
# no more need for Unload,Park, Load etc. Macros anymore. The macro should return to the temp
# the printer had when it was started, regardless ff printer temperature at 0, 40 or 200
# It will check if temperature is high enough to extrude filament ( you have configured your 
# min_extrude_temp in printer.cfg [extruder] didn't you ?!?), if not it will use the default 
# temperature configured down below anyway.
# 
#
# If the printer was not homed - therefore not knowing where it is - it will perform 
# a G28 homing sequence . This will ( better say should ;) ) not happen mid print, don't worry. 
# 
# -----------------------------------------------------
#  DESIGNED TO WORK ESPECIALLY WITH OCTOPRINT
# -----------------------------------------------------
# In Octoprint set Plugins -> Printer Dialogs -> Enable Support = Always
# Thx to u/josolanes for mentioning the fix for this possible issue
#
# Please apologize my english, i'm not a native speaker :)
#
# Those macros are in the magic box:
#
# [M876 S]
# Handle prompt response ( to communicate with octoprint )
#
# [JOBCENTER]
# Handles navigation inside the whole process ( better not to issue as terminal command )
#
# [M125]
# Park head
#
# [M701]
# Load filament
#
# [M702]
# Unload filament
#
# [LOW_TEMP_CHECK T]
# Heatup process & temperature processor
# uses printer.cfg [extruder] section max_temp & min_extrude_temp
#
# [M600]
# Marlin compatible guided Filament Change

#-------------------------------------------------------------------------

#####################
[gcode_macro M876]
#####################

variable_myjob: 0

gcode:

	{% set S = params.S|default(-1)|int %}
	{% set myjob = printer["gcode_macro JOBCENTER"].job %}
	{% if  myjob != 0 %}

		{% if S == 1 %}
			{% set myjob = myjob-2 %}	#Jump to previous Step
          {% elif S == 2%}
               
          {% elif S == 3%}
               {% if myjob == 6003 %}
                    {% set myjob = 6004 %}
               {% else %}
                    {% set myjob = 6003 %}
               {% endif %}
          {% endif %}
          
          {% if myjob == 5999 %}
               JOBCENTER NEWJOB=5999
          {% elif myjob == 6001%}
               JOBCENTER NEWJOB=6001
          {% elif myjob == 6002%}
               JOBCENTER NEWJOB=6002
          {% elif myjob == 6003%}
               JOBCENTER NEWJOB=6003
          {% elif myjob == 6004%}
               JOBCENTER NEWJOB=6004
		{% endif %}

        	

	{% endif %}




#######################
[gcode_macro JOBCENTER]
#######################

variable_temperature: 0
variable_job: 0
variable_myjob: 0
variable_cool: 1
variable_mystep: 1

gcode:
    {% set m600cfg = printer['gcode_macro _m600cfg'] %} ; get m600cfg variables
    RESPOND TYPE=echo MSG="Jobcenter recieved: {params.NEWJOB} "
	{% set NEWJOB = params.NEWJOB|default(0)|int %}
     
	{% set myjob = printer["gcode_macro JOBCENTER"].job %}

	{% if NEWJOB == 6004 %}

		M{printer["gcode_macro m600cfg"].output|int} Extracting ...  #change to printcfg
		M83
    		G92 E0.0
          G1 E{printer["gcode_macro m600cfg"].purge|int} F200 #change to printcfg
          G92 E0.0

		{% set NEWJOB=6005 %}

	{% endif %}

	{% if NEWJOB == 6003 %}

          M{printer["gcode_macro m600cfg"].output|int} Restoring printer state  #change to printcfg

          {% if printer["gcode_macro JOBCENTER"].temperature==0 %}

		     M109 S0

          {% else %}

               M109 S{printer["gcode_macro JOBCENTER"].temperature}

          {% endif%}

	RESUME
     RESPOND TYPE=command MSG="action:notification Resuming print..."

	{% set myjob=0 %}

	{% endif %}

	{% if ( NEWJOB == 6002 or NEWJOB == 6005) %}

		{% if NEWJOB==6002 %}
			M{printer["gcode_macro m600cfg"].output|int} Loading filament  #change to printcfg
			M701

		{% endif %}

		RESPOND TYPE=command MSG="action:prompt_begin {printer["gcode_macro m600cfg"].step_3}"
		RESPOND TYPE=command MSG="action:prompt_choice {printer["gcode_macro m600cfg"].next}"
		RESPOND TYPE=command MSG="action:prompt_choice {printer["gcode_macro m600cfg"].previous}"
		RESPOND TYPE=command MSG="action:prompt_choice {printer["gcode_macro m600cfg"].purgetext} {printer["gcode_macro m600cfg"].purge|int} mm"
		RESPOND TYPE=command MSG="action:prompt_show"

          {% set myjob=6003 %}

	{% endif %}

	{% if NEWJOB == 6001 %}
          RESPOND TYPE=echo MSG="6001 entered"
		LOW_TEMP_CHECK T={printer["gcode_macro JOBCENTER"].temperature}
          RESPOND TYPE=echo MSG="emptying filament"
		M{printer["gcode_macro m600cfg"].output|int} Unloading filament  #change to printcfg
		M702
		RESPOND TYPE=command MSG="action:prompt_begin {printer["gcode_macro m600cfg"].step_2}"
          RESPOND TYPE=command MSG="action:prompt_choice {printer["gcode_macro m600cfg"].next}"
		RESPOND TYPE=command MSG="action:prompt_show"
          RESPOND TYPE=echo MSG="setting 6002"
          {% set myjob=6002 %}

	{% endif %}

	{% if NEWJOB == 5999 %}

          M{printer["gcode_macro m600cfg"].output|int} Restoring printer state

          {% if printer["gcode_macro JOBCENTER"].temperature != 0 %}

			LOW_TEMP_CHECK T={printer["gcode_macro JOBCENTER"].temperature} OVERRIDE=1

		{% endif %}

	     RESUME
          RESPOND TYPE=command MSG="action:notification M600 cancelled"

		{% set myjob=0 %}

	{% endif %}

	{% if NEWJOB == 600 %}

		PAUSE
		M125
		{% set cool=printer["gcode_macro m600cfg"].cooldown|int %}
		{% set mystep=[printer["gcode_macro m600cfg"].step_a1,printer["gcode_macro m600cfg"].step_b1,printer["gcode_macro m600cfg"].step_d1]|join() %}
		{% if cool != 0 %}

			M104 S0
			{% set mystep=[printer["gcode_macro m600cfg"].step_a1,printer["gcode_macro m600cfg"].step_c1,printer["gcode_macro m600cfg"].step_d1]|join() %}

		{% endif %}

		SET_IDLE_TIMEOUT TIMEOUT=7200
		
		RESPOND TYPE=command MSG="action:prompt_begin {mystep}"
		RESPOND TYPE=command MSG="action:prompt_choice {printer["gcode_macro m600cfg"].next}"
		RESPOND TYPE=command MSG="action:prompt_choice {printer["gcode_macro m600cfg"].cancel}"
		RESPOND TYPE=command MSG="action:prompt_show"

          {% set myjob=6001 %}

	{% endif %}

	SET_GCODE_VARIABLE MACRO=JOBCENTER VARIABLE=job VALUE={myjob}


##################
[gcode_macro M125]
##################

gcode:
    {% set m600cfg = printer['gcode_macro _m600cfg'] %} ; get m600cfg variables
	M{printer["gcode_macro m600cfg"].output|int} Moving hotend to {printer["gcode_macro m600cfg"].x|int}, {printer["gcode_macro m600cfg"].y|int}, {printer["gcode_macro m600cfg"].z|int} ({printer["gcode_macro m600cfg"].zmin|int})
	SET_GCODE_VARIABLE MACRO=JOBCENTER VARIABLE=temperature VALUE={printer.extruder.target}

	{% if printer.toolhead.homed_axes != "xyz" %}
	# if  not yet homed

		M{printer["gcode_macro m600cfg"].output|int} Probably not printing. Homing needed ...
		G28

	{% endif %}

     G91

#    	Note to self: Uncomment if ooze experienced (untested yet, just a logical thought)
#	Retract small amount before moving if printer has a temperature set
	{% if printer.extruder.target != 0 %}

		LOW_TEMP_CHECK
        	G1 E-2 F1500

	{% endif %}

	{% if printer.toolhead.position.z|float + printer["gcode_macro m600cfg"].z|float < printer.configfile.config["stepper_z"]["position_max"]|float %}

		{% if  printer.toolhead.position.z < printer["gcode_macro m600cfg"].zmin|int %}

        	  G1 Z{printer["gcode_macro m600cfg"].zmin|int|int-printer.toolhead.position.z|int}

		{% else %}

          	SAVE_GCODE_STATE NAME=save_state
          	G1 Z{printer["gcode_macro m600cfg"].z|int}
               RESTORE_GCODE_STATE NAME=save_state

     	  	{% endif %}

	{% endif%}


	G90
	G1 X{printer["gcode_macro m600cfg"].x|int} Y{printer["gcode_macro m600cfg"].y|int} F{printer["gcode_macro m600cfg"].speed_2|int}

##################
[gcode_macro M701]
##################

gcode:
     {% set m600cfg = printer['gcode_macro _m600cfg'] %} ; get m600cfg variables
     M83
     G92 E0.0
     LOW_TEMP_CHECK
     G1 E{printer["gcode_macro m600cfg"].load_fast|int} F{printer["gcode_macro m600cfg"].speed_1|int}
     G92 E0.0
     G1 E{printer["gcode_macro m600cfg"].load_slow|int} F200
     G92 E0.0


##################
[gcode_macro M702]
##################

gcode:
     {% set m600cfg = printer['gcode_macro _m600cfg'] %} ; get m600cfg variables
     LOW_TEMP_CHECK
     G91
     G1 E10 F1200
     G1 E-{printer["gcode_macro m600cfg"].bowden|int} F{printer["gcode_macro m600cfg"].speed_1|int}
     G90


##################
[gcode_macro M600]
##################

gcode:
 	JOBCENTER NEWJOB=600


############################
[gcode_macro LOW_TEMP_CHECK]
############################

gcode:
     {% set m600cfg = printer['gcode_macro _m600cfg'] %} ; get m600cfg variables
     {% if not params.OVERRIDE is defined %}

          {% if params.T is defined %}

               {% set TMP=params.T|int%}

               {% if printer.configfile.config.extruder.max_temp is defined %}

                    {% if params.T|int>printer.configfile.config.extruder.max_temp|int %}

                         {% set TMP=printer["gcode_macro m600cfg"].default_temp|int %}

                    {% endif %}

               {% endif %}

               {% if TMP|int==0 %}

               {% set TMP=printer["gcode_macro m600cfg"].default_temp|int %}

          {% endif %}

     {% else %}

          {% set TMP=printer["gcode_macro m600cfg"].default_temp|int %}

          {% if printer["gcode_macro JOBCENTER"].temperature|int > 0 %}

               {% set TMP=printer["gcode_macro JOBCENTER"].temperature %}

          {% endif %}

     {% endif %}

     {% if printer.configfile.config.extruder.min_extrude_temp is defined %}

          {% if TMP|int<printer.configfile.config.extruder.min_extrude_temp|int %}

               {% set TMP=printer["gcode_macro m600cfg"].default_temp %}

          {% endif%}

     {% endif %}

     {% else %}

          {% if params.T is defined %}

               {% set TMP=params.T|int %}

          {% else %}

               {% set TMP=printer["gcode_macro m600cfg"].default_temp %}

          {% endif %}

     {% endif %}

     {% if printer.extruder.temperature|int > TMP|int %}

               M{printer["gcode_macro m600cfg"].output|int} Temperature set to {TMP}.   #change to printcfg
               M104 S{TMP}

          {% else %}

               M{printer["gcode_macro m600cfg"].output|int} Heating to {TMP}  #change to printcfg
               M109 S{TMP}

     {% endif %}

##### THAT'S IT !